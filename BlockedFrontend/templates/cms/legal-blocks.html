{% extends "layout_1x3.page.html" %}
{% import "paging.part.html" as paging %}
{%import "remotecontent.part.html" as rmt %}

{%set pagetitle = g.remote_content.title if 'title' in g.remote_content
    else "Website blocking through legal means" %}

{%block page_menu%}
<div><a href="{{ url_for('.legal_errors') }}">Legal block errors</a></div>
<div><a href="{{ url_for('.legal_orders') }}">Court orders index</a></div>
{% endblock %}

{% block col1_row1 %}
{{ g.remote_content.TextAreaOne|safe }}
{%endblock%}

{% block col1_row2 %}
{{ g.remote_content.TextAreaTwo|safe }}
{%endblock%}

{% block col1_row3 %}
{{ g.remote_content.TextAreaThree|safe }}
{%endblock%}

{% block page_style %}

td.courtjudgment {
    background-color: #f7f7f7;
}

td.groupheader h5{
  margin-top: 4px;
  margin-bottom: 4px;
}

td.urlcol {
  padding-left: 1.5em !important;
}

{% endblock %}

{% block bodyrow2 %}
<div class="row">
<div class="col-md-12">

<div class="row">
<div class="col-md-7">
    <h2>Recent legally-blocked sites</h2>
    <h4>{{urlcount}} site{{'s' if urlcount != 1 else '' }} detected</h4>
</div>
<div class="col-md-5" style="padding-top: 20px">
    {% if config['SITE_THEME'] == 'blocked-eu' %}
      <div class="btn-group">
      <button  style="margin-right: 16px" type="button" class="btn btn-lg btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <span class="glyphicon glyphicon-filter"></span>
        Filter by country <span class="caret"></span>
      </button>
      <ul class="dropdown-menu">
        {% if region %}
          <li><a href="{{ url_for('.legal_blocks', page=page, sort=sortorder, region=None) }}">(all)</a></li>
        {% endif %}
        {% for code,country in countries.iteritems() %}
          <li><a href="{{ url_for('.legal_blocks', page=page, sort=sortorder, region=code) }}">{{ country }}</a></li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    <a href="{{ url_for('.export_blocks', region=region) }}" class="btn btn-default btn-lg"><span class="glyphicon glyphicon-save"></span> Export</a>
</div>
</div>

{% if config['SITE_THEME'] == 'blocked-uk' %}
{{ table_courtorders(blocks) }}
{% else %}
{{ table_urllist(blocks) }}
{% endif %}

{{ paging.page_list('.legal_blocks', page, pagecount, region=region, sort=sortorder) }}

</div>
</div>
{% endblock %}

{% macro table_courtorders(blocks) %}
<table class="table">
    <tr>
        <th>Court Judgment / URL</th>
        <th>Networks</th>
        <th>First Detected</th>
        <th>Last Checked</th>
    </tr>
    {% for (courtorder, judgment_date, wiki_url, judgment_url, citation, judgment_sites_description),corows in
        blocks|customgrouper(['judgment_name','judgment_date','wiki_url','judgment_url','citation','judgment_sites_description']) %}
    {% if courtorder %}
    <tr>
        <td colspan="4" class="courtjudgment">
            <h4>{%- if wiki_url -%}<a href="{{wiki_url}}" target="_blank">{%- endif -%}
                {{ courtorder }}
                {%- if wiki_url -%}</a>{%- endif -%}
            </h4>
            {% if judgment_url %}
            <p>Court judgment: <a href="{{ judgment_url}}">{{citation}}</a></p>
            {% endif %}
            <p>{{judgment_date|fmdate}}</p>
            {% if judgment_sites_description %}
            <p>{{ judgment_sites_description|safe }}</p>
            {% endif %}
        </td>
    </tr>
    {% else %}
    <tr>
        <td colspan="4" class="courtjudgment">
            <h4>URLs not yet identified with a legal decision to block</h4>
        </td>
    </tr>
    {% endif %}
    {% for groupname, rows in corows|groupby('url_group_name') %}
    {% if groupname %}
    <tr><td colspan="4" class="groupheader"><h5>{{ groupname }}</h5></td></tr>
    {% endif %}
    {% for row in rows%}
        {% if row.url == None %}
    <tr>
        <td colspan="4">No sites or IP addresses currently detected.</td>
    </tr>
        {% else %}

    <tr>
        <td class="urlcol">{{ row.url }}
        <div class="sitereport"><a href="{{ url_for('site.site', url=row.url) }}">Site report</a></div>
        {% if row.error_status and row.error_status != 'block_appears_correct' %}
        <div style="margin-top: 0.25em">            
            <span class="label label-warning"><span class="glyphicon glyphicon-warning-sign"></span> {{row.error_status|replace('_',' ')|capitalize}}</span>
        </div>
        {% endif %}
        </td>
        <td class="networklist">
            <ul>
            {% for net in row.networks|sort %}
                <li>{{ net }}</li>
            {% endfor %}
            </ul>
        </td>
        <td>{{ row.first_blocked | fmtime }}</td>
        <td>{{ row.last_blocked | fmtime }}</td>
    </tr>
       {% endif %}
    {% endfor %}
    {% endfor %}
    {% endfor %}
</table>
{% endmacro %}

{% macro table_urllist(blocks) %}
<table class="table table-striped">
    <tr>
        <th><a href="{{ url_for('.legal_blocks', page=page, region=region, sort='url') }}" title="Sort by URL">URL</a>
        {% if sortorder == 'url' %}
            <span class="glyphicon glyphicon-chevron-down"></span>
        {% endif %}
        </th>
        <th>Networks</th>
        <th>First Detected</th>
        <th><a href="{{ url_for('.legal_blocks', page=page, region=region, sort='last_blocked') }}" title="Sort by last check date">Last Checked</a>
        {% if sortorder == 'last_blocked' %}
            <span class="glyphicon glyphicon-chevron-down"></span>
        {% endif %}
        </th>
    </tr>
    {% for row in blocks %}
    <tr>
        <td>{{ row.url }}
        <div class="sitereport"><a href="{{ url_for('site.site', url=row.url) }}">Site report</a></div>
        </td>
        <td class="networklist">
            <ul>
            {% for net in row.networks|sort %}
                <li>{{ net }}</li>
            {% endfor %}
            </ul>
        </td>
        <td>{{ row.first_blocked | fmtime }}</td>
        <td>{{ row.last_blocked | fmtime }}</td>
    </tr>
    {% endfor %}
</table>

{% endmacro %}
